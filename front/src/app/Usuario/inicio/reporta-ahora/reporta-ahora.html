<div class="ra-wrapper">
	<!-- Header -->
	<div class="ra-header">
		<div class="ra-title">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
			<div>
				<h2>Reportar Incidente</h2>
				<p class="subtitle">Ayuda a mantener segura a la comunidad universitaria</p>
			</div>
		</div>
		<div class="ra-head-right">
			<div class="ra-badge">
				<div class="dot"></div>
				<div>
					<strong>{{ reportesUsadosHoy }}/{{ reportesLimite }}</strong>
					<span>reportes<br/>hoy</span>
				</div>
			</div>
			<button type="button" class="ra-close" (click)="closeModal()" aria-label="Cerrar" title="Cerrar">×</button>
		</div>
	</div>


	<!-- Alert emergencia (sin ícono, solo texto) -->
	<div class="ra-emergency">
		<p class="title">
			<span class="ico" aria-hidden="true">
				<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
					<path d="M12 9v4"/>
					<path d="M12 17h.01"/>
				</svg>
			</span>
			¿Es una emergencia en curso?
		</p>
		<p class="desc">Si estás en peligro inmediato o presencias un crimen, llama al <strong>911</strong> primero y reporta aquí después.</p>
	</div>

	<!-- Form -->
	<form class="ra-form" novalidate>
		<label>Tipo de Incidente *</label>
		<div class="ra-select-wrap">
			<button type="button" class="ra-select no-left" (click)="toggleTipos()" aria-expanded="{{showTiposMenu}}">
				<span class="placeholder">{{ selectedTipo?.nombre || 'Selecciona el tipo de incidente que quieres reportar' }}</span>
				<span class="chev" aria-hidden="true">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
				</span>
			</button>
			<div class="ra-select-menu" *ngIf="showTiposMenu" (click)="$event.stopPropagation()">
				<div class="menu-item" *ngFor="let t of tipos" (click)="selectTipo(t)">{{ t.nombre }}</div>
				<div class="menu-empty" *ngIf="tipos?.length === 0">Sin datos</div>
			</div>
		</div>
		<p class="hint error" *ngIf="attemptedSubmit && !selectedTipo">Selecciona un tipo de incidente.</p>

		<label>Ubicación del Incidente *</label>
		<div class="ra-select-wrap">
			<button type="button" class="ra-select" (click)="toggleZonas()" aria-expanded="{{showZonasMenu}}">
				<span class="left-icon"> 
					<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
				</span>
				<span class="placeholder">{{ selectedZona?.nombre || '¿En qué zona de la sede ocurrió?' }}</span>
				<span class="chev" aria-hidden="true">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
				</span>
			</button>
			<div class="ra-select-menu" *ngIf="showZonasMenu" (click)="$event.stopPropagation()">
				<div class="menu-item" *ngFor="let z of zonas" (click)="selectZona(z)">{{ z.nombre }}</div>
				<div class="menu-empty" *ngIf="zonas?.length === 0">Sin datos</div>
			</div>
		</div>
		<p class="hint error" *ngIf="attemptedSubmit && !selectedZona">Selecciona la ubicación del incidente.</p>

		<label>Descripción del Incidente *</label>
		<div class="ra-textarea">
			<textarea rows="5" name="descripcion" [(ngModel)]="descripcion" (input)="onDescripcionInput($event)" maxlength="100" placeholder="Describe lo que pasó con el mayor detalle posible:
¿Qué ocurrió exactamente?
¿Cuándo sucedió? (hora aproximada)
¿Había otras personas presentes?
Descripción del agresor (si aplica)
¿Qué objetos fueron sustraídos? (si aplica)"></textarea>
		</div>
		<p class="hint">Entre más detalles proporciones, más útil será para la comunidad.</p>
		<p class="hint count">{{ (descripcion || '').trim().length }}/100 máx • mínimo 10</p>
		<p class="hint error" *ngIf="attemptedSubmit && (descripcion || '').trim().length < 10">La descripción debe tener al menos 10 caracteres.</p>

		<label>Evidencia Fotográfica (Opcional)</label>
				<div class="ra-upload-wrap">
					<button type="button" class="ra-upload" (click)="toggleUploadMenu($event)" aria-haspopup="true" [attr.aria-expanded]="showUploadMenu">
						<ng-container *ngIf="!previewUrl; else previewTpl">
							<div class="icon-wrap" aria-hidden="true">
								<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M3 7h4l2-3h6l2 3h4v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"/><circle cx="12" cy="13" r="4"/></svg>
							</div>
							<strong>Subir foto de evidencia</strong>
							<span class="helper">JPG, PNG hasta 10MB. No incluyas caras de personas sin su consentimiento.</span>
							<span class="file-name" *ngIf="evidenciaFile">{{ evidenciaFile.name }}</span>
						</ng-container>
						<ng-template #previewTpl>
							<div class="preview-box">
								<img [src]="previewUrl" alt="Vista previa de evidencia" />
								<button type="button" class="remove" (click)="$event.stopPropagation(); removeEvidence()" title="Eliminar">×</button>
							</div>
						</ng-template>
					</button>
					<div class="ra-upload-menu" *ngIf="showUploadMenu" (click)="$event.stopPropagation()">
						<button type="button" class="menu-item" (click)="pickFromFiles()">Subir desde archivos</button>
						<button type="button" class="menu-item" (click)="pickFromCamera()">Tomar foto ahora</button>
					</div>
				</div>
				<input id="ra-file-input" class="ra-file" type="file" accept="image/*" (change)="onFileChange($event)" />
				<input id="ra-camera-input" class="ra-file" type="file" accept="image/*" capture="environment" (change)="onFileChange($event)" />

			<!-- Anónimo -->
			<div class="ra-anon" (click)="onAnonCardClick($event)" tabindex="0" (keydown)="onAnonCardKeydown($event)">
				<div class="ra-top">
					<label class="ra-check">
						<input type="checkbox" name="isAnonimo" [(ngModel)]="isAnonimo" />
						<span class="ico" aria-hidden="true">
							<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>
							</svg>
						</span>
						<span class="lbl">Enviar como denuncia anónima</span>
					</label>
					<p class="desc">Tu reporte será completamente anónimo. No se guardará ninguna información que pueda identificarte.</p>
				</div>
				<ng-container *ngIf="!isAnonimo">
					<hr class="ra-subdivider"/>
					<button type="button" class="ra-ct-ctl no-toggle" (click)="toggleContactInfo($event)">
						<span class="ico" aria-hidden="true">
							<ng-container *ngIf="showContactInfo; else eyeOpen">
								<!-- Ojo cerrado (ocultar) -->
								<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-5 0-9.27-3-11-8 1.02-2.53 2.67-4.67 4.74-6.2"/>
									<path d="M1 1l22 22"/>
									<path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/>
									<path d="M6.1 6.1A10.94 10.94 0 0 1 12 4c5 0 9.27 3 11 8-.66 1.65-1.62 3.11-2.77 4.28"/>
								</svg>
							</ng-container>
							<ng-template #eyeOpen>
								<!-- Ojo abierto (mostrar) -->
								<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/>
									<circle cx="12" cy="12" r="3"/>
								</svg>
							</ng-template>
						</span>
						{{ showContactInfo ? 'Ocultar información de contacto' : 'Agregar información de contacto' }}
					</button>
					<div class="ra-contact no-toggle" *ngIf="showContactInfo">
						<h4 class="ra-contact-title">Información de contacto</h4>
						<input class="ra-input" type="text" [(ngModel)]="contacto" name="contacto" placeholder="Email adicional o teléfono (opcional)" />
						<p class="ra-note">Ya tenemos tu información de estudiante. Puedes agregar contacto adicional si lo deseas.</p>
					</div>
				</ng-container>
			</div>

			<!-- Acciones -->
			<div class="ra-actions">
				<button type="button" class="ra-btn neutral" (click)="$event.preventDefault(); $event.stopPropagation(); closeModal()">Cancelar</button>
				<button type="button" class="ra-btn primary" [disabled]="submitting || limiteAlcanzado" (click)="enviarReporte()">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
					{{ limiteAlcanzado ? 'Límite alcanzado' : 'Enviar Reporte' }}
				</button>
			</div>

			<hr class="ra-divider"/>
			<p class="ra-disclaimer">Al enviar este reporte, confirmas que la información proporcionada es veraz y ayudará a mejorar la seguridad de toda la comunidad universitaria.</p>
	</form>
</div>

	<!-- Overlay de cámara -->
	<div class="ra-cam-backdrop" *ngIf="showCamera" (click)="closeCamera()">
		<div class="ra-cam-modal" (click)="$event.stopPropagation()">
			<div class="ra-cam-header">
				<strong>{{ snapshotUrl ? 'Verifica la foto' : 'Tomar foto' }}</strong>
				<button type="button" class="x" (click)="closeCamera()">×</button>
			</div>
			<div class="ra-cam-body" [class.center]="!!snapshotUrl">
				<ng-container *ngIf="!snapshotUrl; else snapshotTpl">
					<video id="ra-camera-video" playsinline autoplay muted></video>
				</ng-container>
				<ng-template #snapshotTpl>
					<img [src]="snapshotUrl" alt="Foto tomada" />
				</ng-template>
			</div>
			<div class="ra-cam-actions">
				<ng-container *ngIf="!snapshotUrl; else confirmTpl">
					<button type="button" class="ra-btn neutral" (click)="closeCamera()">Cancelar</button>
					<button type="button" class="ra-btn primary" (click)="capturePhoto()">Capturar</button>
				</ng-container>
				<ng-template #confirmTpl>
					<button type="button" class="ra-btn neutral" (click)="retakeSnapshot()">Repetir</button>
					<button type="button" class="ra-btn primary" (click)="confirmSnapshot()">Usar esta</button>
				</ng-template>
			</div>
		</div>
	</div>
