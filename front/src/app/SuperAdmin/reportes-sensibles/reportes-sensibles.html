<!-- Modal de re-autenticaci√≥n para acceder a reportes sensibles -->
<div *ngIf="showAuthModal" class="modal-backdrop">
	<div class="modal-card">
		<button class="modal-close" (click)="cancelAuth()">‚úï</button>
		<h3>Acceso a Reportes Sensibles</h3>
		<p class="muted">Esta secci√≥n contiene informaci√≥n confidencial de todos los reportes. Se requiere autenticaci√≥n adicional.</p>

		<div class="alert alert-info">üîí Solo el SuperAdmin puede acceder a esta informaci√≥n sensible.</div>

		<label class="block text-sm font-medium mt-3">Contrase√±a de Acceso Sensible</label>
		<input type="password" placeholder="Ingrese la contrase√±a especial" [(ngModel)]="passwordInput" class="input-field" />
		<p *ngIf="authError" class="text-xs text-red-500 mt-2">{{ authError }}</p>

		<div class="modal-actions">
			<button class="btn btn-primary" (click)="submitAuth()" [disabled]="loadingAuth">
				<span *ngIf="!loadingAuth">üîí Autenticar</span>
				<span *ngIf="loadingAuth">Validando...</span>
			</button>
			<button class="btn btn-outline" (click)="cancelAuth()" [disabled]="loadingAuth">Cancelar</button>
		</div>
	</div>
</div>

<!-- Contenido sensible: solo visible si accesoConcedido -->
<div *ngIf="accesoConcedido" class="sensitive-area">
	<div class="header-row">
		<h2>Panel de Reportes Sensibles</h2>
		<button class="btn btn-outline" (click)="loadReports()">Actualizar</button>
	</div>

	<!-- Visor de imagen en modal (evidencia) -->
	<div *ngIf="imageModalVisible" class="modal-backdrop" (click)="closeImage()" style="position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999;">
		<div class="modal-card" (click)="$event.stopPropagation()" style="background:transparent; box-shadow:none; border:none; padding:0;">
			<img [src]="selectedImageSrc" alt="Evidencia" style="max-width:92vw; max-height:85vh; border-radius:10px; display:block;" />
		</div>
	</div>

	<!-- Banner superior y tarjetas de m√©tricas (igualito al mock) -->
	<div class="top-banner">
		<div class="banner-inner">
			<div class="banner-left">
				<div class="banner-title">Reportes Sensibles</div>
				<div class="banner-sub">- Acceso a informaci√≥n confidencial y identidad real de todos los reportes.</div>
			</div>
			<div class="banner-right">
				<button class="btn btn-outline" (click)="closeSensitiveSession()">
					<!-- Lock icon -->
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="width:16px;height:16px;margin-right:8px;">
						<rect x="3" y="11" width="18" height="11" rx="2"></rect>
						<path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
					</svg>
					Cerrar Sesi√≥n Sensible
				</button>
			</div>
		</div>
	</div>

	<div class="stats-row">
		<div class="stat-card card-1">
			<div class="stat-icon">
				<!-- Tabler file icon -->
				<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-file" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					<path stroke="none" d="M0 0h24v24H0z" fill="none"/>
					<path d="M14 3v4a1 1 0 0 0 1 1h4" />
					<path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
				</svg>
			</div>
			<div class="stat-body">
				<div class="stat-number">{{ totalReports }}</div>
				<div class="stat-label">Total Reportes</div>
			</div>
		</div>
		<div class="stat-card card-2">
			<div class="stat-icon">
				<!-- Tabler eye icon -->
				<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-eye" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					<path stroke="none" d="M0 0h24v24H0z" fill="none"/>
					<path d="M2 12s4 -7 10 -7 10 7 10 7 -4 7 -10 7 -10 -7 -10 -7" />
					<circle cx="12" cy="12" r="3" />
				</svg>
			</div>
			<div class="stat-body">
				<div class="stat-number">{{ identificadosCount }}</div>
				<div class="stat-label">Identificados</div>
			</div>
		</div>
		<div class="stat-card card-3">
			<div class="stat-icon">
				<!-- Tabler eye-off icon (inline for crisp rendering) -->
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-eye-off" aria-hidden="true">
					<path stroke="none" d="M0 0h24v24H0z" fill="none"/>
					<path d="M10.585 10.587a2 2 0 0 0 2.829 2.828" />
					<path d="M16.681 16.673a8.717 8.717 0 0 1 -4.681 1.327c-3.6 0 -6.6 -2 -9 -6c1.272 -2.12 2.712 -3.678 4.32 -4.674m2.86 -1.146a9.055 9.055 0 0 1 1.82 -.18c3.6 0 6.6 2 9 6c-.666 1.11 -1.379 2.067 -2.138 2.87" />
					<path d="M3 3l18 18" />
				</svg>
			</div>
			<div class="stat-body">
				<div class="stat-number">{{ anonimosCount }}</div>
				<div class="stat-label">An√≥nimos</div>
			</div>
		</div>
		<div class="stat-card card-4">
			<div class="stat-icon">
				<!-- Tabler alert-triangle icon -->
				<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-alert-triangle" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					<path stroke="none" d="M0 0h24v24H0z" fill="none"/>
					<path d="M10.29 3.86l-8.47 14.14a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3l-8.47-14.14a2 2 0 0 0-3.42 0z" />
					<path d="M12 9v4" />
					<circle cx="12" cy="17" r="1" />
				</svg>
			</div>
			<div class="stat-body">
				<div class="stat-number">{{ altaPrioridadCount }}</div>
				<div class="stat-label">Alta Prioridad</div>
			</div>
		</div>
		<div class="stat-card card-5">
			<div class="stat-icon">
				<!-- User with check icon (reemplazado por Tabler icon provided) -->
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-user-check" aria-hidden="true"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /><path d="M6 21v-2a4 4 0 0 1 4 -4h4" /><path d="M15 19l2 2l4 -4" /></svg>
			</div>
			<div class="stat-body">
				<div class="stat-number">{{ uniqueUsersCount }}</div>
				<div class="stat-label">Usuarios √önicos</div>
			</div>
		</div>
	</div>

	<!-- filtros simples -->
	<div class="filters">
		<input type="text" placeholder="Buscar usuario, email, descripci√≥n..." [(ngModel)]="searchText" class="input-field" />
		<select [(ngModel)]="selectedEstado" class="select-field">
			<option value="all">Todos</option>
			<option value="PENDIENTE">Pendiente</option>
			<option value="INVESTIGANDO">Investigando</option>
			<option value="EN_PROCESO">En proceso</option>
			<option value="RESUELTO">Resuelto</option>
			<option value="CANCELADO">Cancelado</option>
		</select>
		<select [(ngModel)]="selectedPrioridad" class="select-field">
			<option value="all">Todas</option>
			<option value="ALTA">Alta</option>
			<option value="MEDIA">Media</option>
			<option value="BAJA">Baja</option>
		</select>
		<select [(ngModel)]="selectedTipo" class="select-field">
			<option value="all">Todos</option>
			<option *ngFor="let t of tipos" [value]="t.id">{{ t.nombre }}</option>
		</select>

		<!-- Botones adicionales: Limpiar y Exportar -->
		<div class="filter-actions">
			<button class="btn btn-outline" (click)="clearFilters()">Limpiar</button>
			<button class="btn btn-primary" (click)="exportToExcel()">Exportar</button>
		</div>
	</div>

	<div class="report-list">
		<div *ngIf="!reports || reports.length === 0" class="empty">No hay reportes sensibles.</div>
			<div *ngFor="let r of filteredReports" class="report-card">
				<div class="card-header">
					<div class="badges">
						<span class="badge priority" *ngIf="r.reporteGestion && r.reporteGestion.prioridad"
						      [ngClass]="{
						        'alta': (r.reporteGestion.prioridad||'').toUpperCase() === 'ALTA',
						        'media': (r.reporteGestion.prioridad||'').toUpperCase() === 'MEDIA',
						        'baja': (r.reporteGestion.prioridad||'').toUpperCase() === 'BAJA'
						      }">{{ r.reporteGestion.prioridad }}</span>
						<span class="badge estado">{{ (r.reporteGestion && r.reporteGestion.estado) ? r.reporteGestion.estado : (r.ultimoEstado || '') }}</span>
						<span class="badge tipo">{{ (r.isAnonimo ? 'AN√ìNIMO' : 'IDENTIFICADO') }}</span>
						<span class="badge small" *ngIf="r.ultimaPrioridad === 'nuevo'">nuevo</span>
					</div>
					<button class="btn btn-outline" (click)="abrirDetalle(r)">Ver Detalle</button>
				</div>

				<div class="report-main">
							<div class="report-left">
								<h3 class="report-title">{{ getZonaName(r) }}</h3>
								<div class="report-subtitle">{{ getTipoName(r) }}</div>
						<p class="report-desc">{{ r.descripcion }}</p>

						<div class="confidential-box">
							<div class="conf-title">Informaci√≥n Confidencial del Reporter</div>
							<div class="conf-rows">
								<div class="conf-item">
									<span class="icon">
										<!-- Person icon -->
										<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
											<circle cx="12" cy="7" r="4"></circle>
											<path d="M5.5 21a6.5 6.5 0 0 1 13 0"></path>
										</svg>
									</span>
									<div class="conf-text">{{ getReporterName(r) }}</div>
								</div>
								<div class="conf-item">
									<span class="icon">
										<!-- Mail icon (updated) -->
										<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
											<rect x="2" y="5" width="20" height="14" rx="2"></rect>
											<path d="M22 7l-10 7L2 7"></path>
										</svg>
									</span>
									<div class="conf-text">{{ getReporterCorreo(r) }}</div>
								</div>
								<div class="conf-item">
									<span class="icon">
										<!-- Lock icon -->
										<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
											<rect x="3" y="11" width="18" height="11" rx="2"></rect>
											<path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
										</svg>
									</span>
									<div class="conf-text">Rol: {{ getReporterRol(r) }}</div>
								</div>
							</div>
						</div>
					</div>
							<!-- report-right removed: meta moved to footer -->
				</div>
						<div class="card-footer horizontal">
							<div class="meta-left">
								<span class="icon">
									<!-- Pin / location icon -->
									<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
										<path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 0 1 18 0z"></path>
										<circle cx="12" cy="10" r="2"></circle>
									</svg>
								</span>
								{{ getZonaName(r) }}
							</div>
							<div class="meta-right">
								<span class="icon">
									<!-- Clock icon -->
									<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
										<circle cx="12" cy="12" r="10"></circle>
										<path d="M12 6v6l4 2"></path>
									</svg>
								</span>
								{{ formatDate(r.fechaCreacion) }} ¬∑ Actualizado: {{ formatDate(r.fechaUltimaGestion || r.fechaCreacion) }}
							</div>
						</div>
			</div>
	</div>
</div>

<!-- Modal Detalle Completo (SuperAdmin) -->
<div *ngIf="detalleVisible && reporteSeleccionado as det" class="modal-backdrop" (click)="cerrarDetalle()" style="align-items:flex-start; padding:32px 20px; overflow:auto;">
	<div class="sa-detail-card" (click)="$event.stopPropagation()">
		<!-- Header -->
		<div class="sa-header">
			<div style="display:flex; align-items:center; gap:14px;">
				<div class="color-bar" [style.background]="(det.reporteGestion?.prioridad||det.ultimaPrioridad||'').toUpperCase()==='ALTA' ? '#ef4444' : ((det.reporteGestion?.prioridad||det.ultimaPrioridad||'').toUpperCase()==='MEDIA' ? '#f59e0b' : '#3b82f6')"></div>
				<div>
					<div class="title">{{ det.isAnonimo ? 'Reporte An√≥nimo' : getTipoName(det) }}</div>
					<div class="subtitle">{{ getZonaName(det) }} ‚Ä¢ ID: {{ det.id }}</div>
				</div>
			</div>
			<button class="close" (click)="cerrarDetalle()">‚úï</button>
		</div>
		<!-- Body -->
		<div class="sa-body">
			<div class="sa-grid">
				<!-- Columna izquierda -->
				<div class="sa-left" style="display:flex; flex-direction:column; gap:14px;">
					<div style="display:flex; align-items:center; gap:12px;">
						<div class="avatar">{{ det.isAnonimo ? 'A' : (det.usuarioId || 'U') }}</div>
						<div>
							<div style="font-weight:600; font-size:15px;">{{ det.isAnonimo ? 'An√≥nimo' : ('Usuario #' + det.usuarioId) }}</div>
							<div style="color:#64748b; font-size:12px;">{{ det.isAnonimo ? 'Reporte An√≥nimo' : 'Con contacto' }}</div>
						</div>
						<div class="sa-badges">
							<span class="sa-badge" [ngClass]="{
								'prio-alta': (det.reporteGestion?.prioridad||det.ultimaPrioridad||'').toUpperCase()==='ALTA',
								'prio-media': (det.reporteGestion?.prioridad||det.ultimaPrioridad||'').toUpperCase()==='MEDIA',
								'prio-baja': (det.reporteGestion?.prioridad||det.ultimaPrioridad||'').toUpperCase()==='BAJA'
							}">{{ (det.reporteGestion?.prioridad || det.ultimaPrioridad || '') | uppercase }}</span>
							<span class="sa-badge estado">{{ (det.reporteGestion?.estado || det.ultimoEstado || '').toUpperCase() }}</span>
						</div>
					</div>

					<div class="sa-box">
						<div class="label">Descripci√≥n inicial</div>
						<div style="font-size:13px; line-height:1.45; color:#334155; white-space:pre-wrap;">{{ det.descripcion }}</div>
					</div>

					<!-- Confidencial: siempre mostrar identidad real -->
					<div class="sa-conf">
						<div class="conf-title">Informaci√≥n Confidencial del Reportante</div>
						<div class="row">
							<span class="icon">
								<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
									<circle cx="12" cy="7" r="4"></circle>
									<path d="M5.5 21a6.5 6.5 0 0 1 13 0"></path>
								</svg>
							</span>
							<div>{{ getReporterName(det) }}</div>
						</div>
						<div class="row">
							<span class="icon">
								<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
									<rect x="2" y="5" width="20" height="14" rx="2"></rect>
									<path d="M22 7l-10 7L2 7"></path>
								</svg>
							</span>
							<div>{{ getReporterCorreo(det) }}</div>
						</div>
						<div class="row">
							<span class="icon">
								<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
									<rect x="3" y="11" width="18" height="11" rx="2"></rect>
									<path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
								</svg>
							</span>
							<div>Rol: {{ getReporterRol(det) }}</div>
						</div>
					</div>

					<div *ngIf="getImageSrc(det) as img">
						<div class="label" style="font-weight:600; font-size:14px;">Evidencia</div>
						<div class="sa-evidence">
							<img [src]="img" (click)="openImage(img)" alt="Evidencia" />
							<div style="display:flex; flex-direction:column; gap:8px;">
								<button (click)="openImage(img)" class="btn btn-outline" style="padding:6px 10px;">Abrir evidencia</button>
								<div style="font-size:12px; color:#64748b;">Click para ampliar en un visor modal.</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Columna derecha: estados -->
				<div style="display:flex; flex-direction:column; gap:16px;">
					<div class="sa-states-title">Estados y tiempos</div>
					<div class="sa-states">
						<div *ngFor="let e of estadosDetalle()" class="sa-state-card">
							<div class="sa-state-head">
								<div class="left">
									<span class="sa-dot" [ngClass]="e.key"></span>
									<div style="font-size:13px; font-weight:600;">{{ e.label }}</div>
								</div>
								<div class="sa-state-date">{{ e.fecha ? (e.fecha | date:'dd/MM/yy, h:mm a') : 'No registrado' }}</div>
							</div>
							<div *ngIf="e.fecha" class="sa-date-grid">
								<div>
									<div class="label">Fecha</div>
									<div class="value">{{ e.fecha | date:'dd/MM/yy' }}</div>
								</div>
								<div>
									<div class="label">Hora</div>
									<div class="value">{{ e.fecha | date:'h:mm a' }}</div>
								</div>
							</div>
							<ng-container *ngIf="e.comentarios as cm; else noCommentSA">
								<div class="sa-comment" [ngClass]="e.origin==='admin' ? 'admin' : 'seguridad'">
									<div class="who">{{ e.origin==='admin' ? 'Administrador' : 'Seguridad' }}</div>
									<div style="white-space:pre-wrap;">{{ cm }}</div>
								</div>
							</ng-container>
							<ng-template #noCommentSA>
								<div style="color:#94a3b8; font-size:11px;">Sin comentarios.</div>
							</ng-template>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
