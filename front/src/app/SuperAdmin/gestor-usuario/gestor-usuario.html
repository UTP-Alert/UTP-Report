<div class="section-banner">
	<span class="banner-icon" aria-hidden="true">
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-crown"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 6l4 6l5 -4l-2 10h-14l-2 -10l5 4z" /></svg>
	</span>
	<div class="banner-content">
		<h2>Gestión de Usuarios</h2>
		<p>- Panel exclusivo del SuperAdmin para administrar todos los usuarios del sistema UTP+Report.</p>
	</div>
</div>

	<div class="user-stats">
		<h3 class="subsection-title">
        <span class="title-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-users"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" /><path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /><path d="M21 21v-2a4 4 0 0 0 -3 -3.85" /></svg>
        </span>
        <span>Gestión de Usuarios del Sistema</span>
      </h3>
		<div class="stats-cards">
			<div class="stat-card">
          <span class="stat-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-school"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 9l-10 -4l-10 4l10 4l10 -4v6" /><path d="M6 10.6v5.4a6 3 0 0 0 12 0v-5.4" /></svg>
          </span>
          <div class="metric">
            <div class="value">1</div>
            <div class="label">Estudiantes</div>
          </div>
			</div>
			<div class="stat-card">
          <span class="stat-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-book"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0" /><path d="M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0" /><path d="M3 6l0 13" /><path d="M12 6l0 13" /><path d="M21 6l0 13" /></svg>
          </span>
          <div class="metric">
            <div class="value">0</div>
            <div class="label">Docentes</div>
          </div>
			</div>
			<div class="stat-card">
          <span class="stat-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-shield"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3a12 12 0 0 0 8.5 3a12 12 0 0 1 -8.5 15a12 12 0 0 1 -8.5 -15a12 12 0 0 0 8.5 -3" /></svg>
          </span>
          <div class="metric">
            <div class="value">1</div>
            <div class="label">Administradores</div>
          </div>
			</div>
			<div class="stat-card">
          <span class="stat-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-user-shield"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 21v-2a4 4 0 0 1 4 -4h2" /><path d="M22 16c0 4 -2.5 6 -3.5 6s-3.5 -2 -3.5 -6c1 0 2.5 -.5 3.5 -1.5c1 1 2.5 1.5 3.5 1.5z" /><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /></svg>
          </span>
          <div class="metric">
            <div class="value">1</div>
            <div class="label">Personal Seguridad</div>
          </div>
			</div>
			<div class="stat-card">
          <span class="stat-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-users"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" /><path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /><path d="M21 21v-2a4 4 0 0 0 -3 -3.85" /></svg>
          </span>
          <div class="metric">
            <div class="value">4</div>
            <div class="label">Usuarios Activos</div>
          </div>
			</div>
		</div>
	</div>

	<div class="user-filters">
		<input type="text" placeholder="Buscar usuarios...">
		<select>
			<option>Todos los roles</option>
		</select>
		<select>
			<option>Todos los estados</option>
		</select>
		<button class="clear-filters-btn">Limpiar Filtros</button>
			<button class="create-user-btn" (click)="openCreate()"><i class="fas fa-user-plus"></i> Crear
				Usuario</button>
	</div>

	<!-- FORMULARIO DE CREACIÓN/EDICIÓN DE USUARIOS -->
	<div class="form-wrapper">
	<div *ngIf="isCreating || editingUser" class="card border-primary bg-red-50 mb-6">
		<div class="card-header">
			<h2 class="card-title">
				{{ editingUser ? 'Editar Usuario' : 'Crear Nuevo Usuario' }}
			</h2>
		</div>
		<div class="card-content space-y-4">

			<!-- CAMPOS PRINCIPALES EN GRID 3 COLUMNAS -->
			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

				<!-- 1. NOMBRE COMPLETO -->
				<div>
					<label class="block text-sm font-medium mb-1">Nombre Completo</label>
					<input type="text" placeholder="Ej: Juan Pérez" [(ngModel)]="formData.name"
						[class.border-red-500]="formErrors.name" class="input-field" />
					<p *ngIf="formErrors.name" class="text-xs text-red-500 mt-1">{{ formErrors.name }}</p>
				</div>

				<div>
					<label class="block text-sm font-medium mb-1">Usuario</label>
					<input type="text" placeholder="CODIGO UTP" [(ngModel)]="formData.username"
						[class.border-red-500]="formErrors.username" class="input-field" [readonly]="isUsernameAuto" />
					<p *ngIf="formErrors.username" class="text-xs text-red-500 mt-1">{{ formErrors.username }}</p>
				</div>



				<!-- 2. EMAIL CON VALIDACIÓN AUTOMÁTICA POR ROL -->
				<div>
					<label class="block text-sm font-medium mb-1">Email</label>
					<input type="email" [placeholder]="
							formData.role === 'user' ? (
								formData.userType === 'alumno' ? 'U1234567@utp.edu.pe' : 'C54321@utp.edu.pe'
							) :
							formData.role === 'admin' ? 'D1234567@utp.edu.pe' :
							formData.role === 'seguridad' ? 'S001@utp.edu.pe' :
							'usuario@utp.edu.pe'
						" [(ngModel)]="formData.correo" [class.border-red-500]="formErrors.correo" class="input-field"
						pattern=".*@utp\.edu\.pe$" title="El correo debe ser del dominio @utp.edu.pe" [readonly]="isCorreoAuto" />
					<p *ngIf="formErrors.correo" class="text-xs text-red-500 mt-1">{{ formErrors.correo }}</p>

					<!-- HINTS DINÁMICOS SEGÚN ROL -->
					<p *ngIf="formData.role === 'usuario' && formData.userType === 'alumno'"
						class="text-xs text-gray-500 mt-1">
						Para estudiantes: usar código UTP (Ej: U1234567@utp.edu.pe)
					</p>
					<p *ngIf="formData.role === 'usuario' && formData.userType === 'docente'"
						class="text-xs text-gray-500 mt-1">
						Para docentes: usar código UTP (Ej: C54321@utp.edu.pe)
					</p>
					<p *ngIf="formData.role === 'admin'" class="text-xs text-gray-500 mt-1">
						Para administradores: usar código personal (Ej: D1234567@utp.edu.pe)
					</p>
					<p *ngIf="formData.role === 'seguridad'" class="text-xs text-gray-500 mt-1">
						Para seguridad: usar código de empleado (Ej: S001@utp.edu.pe)
					</p>
				</div>

				<!-- 3. CONTRASEÑA -->
				<div class="relative">
					<label class="block text-sm font-medium mb-1">Contraseña</label>
					<input [type]="showPassword ? 'text' : 'password'" placeholder="Mínimo 6 caracteres"
						[(ngModel)]="formData.password" [class.border-red-500]="formErrors.password" class="input-field pr-10" />
					<button type="button" (click)="togglePasswordVisibility()"
						class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5 h-full password-toggle-btn">
						<i class="fas" [class.fa-eye]="!showPassword" [class.fa-eye-slash]="showPassword"></i>
					</button>
					<p *ngIf="formErrors.password" class="text-xs text-red-500 mt-1">{{ formErrors.password }}</p>
					<p class="text-xs text-gray-500 mt-1">
						{{ editingUser ? 'Dejar en blanco para mantener contraseña actual' : 'Contraseña para acceder al
						sistema' }}
					</p>
				</div>

				<!-- 4. TELÉFONO -->
				<div>
					<label class="block text-sm font-medium mb-1">Celular</label>
					<input type="text" placeholder="999000000" [(ngModel)]="formData.phone" maxlength="9"
						[class.border-red-500]="formErrors.phone" class="input-field" />
					<p *ngIf="formErrors.phone" class="text-xs text-red-500 mt-1">{{ formErrors.phone }}</p>
				</div>

				<!-- 5. ROL CON ICONOS -->
				<div>
					<label class="block text-sm font-medium mb-1">Rol</label>
					<select [(ngModel)]="formData.role" (change)="onRoleChange($event)"
						[class.border-red-500]="formErrors.role" class="select-field">
						<option value="" disabled selected>Seleccionar Rol</option> <!-- Added default option -->
						<option *ngFor="let roleKey of (roleConfig | keyvalue)" [value]="roleKey.key">
							<i [class]="roleKey.value.icon"></i> {{ roleKey.value.label }}
						</option>
					</select>
					<p *ngIf="formErrors.role" class="text-xs text-red-500 mt-1">{{ formErrors.role }}</p>
				</div>

				<!-- 6. SEDE -->
				<div>
					<label class="block text-sm font-medium mb-1">Sede</label>
					<select [(ngModel)]="formData.campus" (change)="onSedeChange($event)" [class.border-red-500]="formErrors.campus" class="select-field">
						<option value="" disabled selected>Seleccionar Sede</option> <!-- Added default option -->
						<!-- Mostrar mensaje cuando no haya sedes -->
						<option *ngIf="sedes.length === 0" value="" disabled>
							No hay sedes disponibles
						</option>

						<!-- Mostrar las sedes disponibles -->
						<option *ngFor="let sede of sedes" [value]="sede.id">
							<i class="fas fa-building"></i> {{ sede.nombre }}
						</option>
					</select>
					<p *ngIf="formErrors.campus" class="text-xs text-red-500 mt-1">{{ formErrors.campus }}</p>
				</div>
			</div>

			<!-- SECCIÓN ESPECIAL: TIPO DE USUARIO (Solo para rol 'user') -->
			<div *ngIf="formData.role === 'usuario'" class="bg-blue-50 border-2 border-blue-200 p-4 rounded-lg">
				<label class="block text-sm font-medium mb-2 text-blue-800 flex items-center gap-2">
					<i class="fas fa-user h-4 w-4"></i>
					👥 Tipo de Usuario (OBLIGATORIO)
				</label>
				<select [(ngModel)]="formData.userType" (change)="onUserTypeChange($event)" [class.border-red-500]="formErrors.userType"
					class="select-field border-blue-300">
					<option value="" disabled selected>Seleccionar Tipo de Usuario</option> <!-- Added default option -->
					<option value="alumno">
						<i class="fas fa-graduation-cap h-4 w-4 text-blue-600"></i>
						<span>👨‍🎓 alumno</span>
						<span class="badge ml-2 bg-blue-100 text-blue-700">U1234567</span>
					</option>
					<option value="docente">
						<i class="fas fa-book-open h-4 w-4 text-purple-600"></i>
						<span>👨‍🏫 Docente</span>
						<span class="badge ml-2 bg-purple-100 text-purple-700">C54321</span>
					</option>
				</select>
				<p *ngIf="formErrors.userType" class="text-xs text-red-500 mt-1">{{ formErrors.userType }}</p>
				<p class="text-xs text-blue-600 mt-2">
					ℹ️ Selecciona si es estudiante o docente para determinar el formato del código UTP
				</p>
			</div>

			<!-- SECCIÓN ESPECIAL: ZONAS ASIGNADAS (Solo para rol 'seguridad') -->

			<div *ngIf="formData.role === 'seguridad'"
				class="border-t-2 border-primary pt-6 mt-4 bg-green-50 p-4 rounded-lg">

				<!-- Título de la sección -->
				<label class="block text-lg font-medium mb-4 flex items-center gap-2 text-green-800">
					<i class="fas fa-map-marker-alt h-5 w-5 text-green-600"></i>
					🗺️ Zonas Designadas para Patrullaje (OBLIGATORIO)
				</label>

				<div class="space-y-3">
					<!-- ALERTA CUANDO NO HAY ZONAS -->
					<div *ngIf="formData.assignedZones.length === 0"
						class="bg-red-50 border-2 border-red-200 p-4 rounded-lg">
						<div class="flex items-center gap-2 text-red-800 mb-2">
							<i class="fas fa-map-marker-alt h-5 w-5"></i>
							<span class="font-medium">🚨 SIN ZONAS ASIGNADAS</span>
						</div>
						<p class="text-sm text-red-700">
							Debes asignar al menos una zona antes de poder crear este usuario de seguridad.
						</p>
					</div>

					<!-- ZONAS ACTUALMENTE ASIGNADAS -->
					<div *ngIf="formData.assignedZones.length > 0"
						class="bg-green-50 border-2 border-green-200 p-3 rounded-lg">
						<p class="text-sm font-medium text-green-800 mb-2 flex items-center gap-2">
							<i class="fas fa-map-marker-alt h-4 w-4"></i>
							✅ Zonas asignadas ({{ formData.assignedZones.length }}):
						</p>
						<div class="flex flex-wrap gap-2">
							<span *ngFor="let zone of formData.assignedZones"
								class="badge pr-1 bg-white border-green-300 font-bold text-green-800">
								{{ zone.nombre }}
								<button type="button" (click)="handleRemoveZone(zone)"
									class="ml-2 h-4 w-4 p-0 hover:bg-red-100 remove-zone-btn">
									<i class="fas fa-times h-3 w-3"></i>
								</button>
							</span>
						</div>
					</div>

					<!-- SELECTOR PARA AGREGAR ZONAS -->
					<div>
						<p class="text-sm font-medium text-green-800 mb-2 flex items-center gap-2">
							<i class="fas fa-map-marker-alt h-4 w-4"></i>
							Agregar zona de la sede:
						</p>
						<select (change)="onAddZoneChange($event)" class="select-field"
							[class.border-red-300]="formData.assignedZones.length === 0 || formErrors.assignedZones"
							[class.bg-red-50]="formData.assignedZones.length === 0 || formErrors.assignedZones"
							[class.border-green-300]="formData.assignedZones.length > 0">
							<option value="" disabled selected>
								{{ filteredAvailableZones.length === 0
								? "⚠️ No hay zonas disponibles para asignar"
								: (formData.assignedZones.length === 0
								? "🚨 SELECCIONAR ZONA OBLIGATORIA"
								: "Seleccionar zona adicional")
								}}
							</option>

							<option *ngFor="let zone of filteredAvailableZones" [value]="zone.id">
								<i class="fas fa-map-marker-alt h-4 w-4 text-green-600"></i>
								{{ zone.nombre }}
							</option>
						</select>
						<p *ngIf="formErrors.assignedZones" class="text-xs text-red-500 mt-1">{{ formErrors.assignedZones }}</p>
				</div>


			</div>



		</div>



		<!-- BOTONES DE ACCIÓN -->
		<div class="flex justify-end gap-3 pt-4 border-t">
			<button type="button" class="btn btn-outline" (click)="resetForm()">
				Cancelar
			</button>
			<button type="button" (click)="editingUser ? handleUpdateUser() : handleCreateUser()"
				class="btn bg-primary hover:bg-primary/90">
				{{ editingUser ? 'Actualizar Usuario' : 'Crear Usuario' }}
			</button>
		</div>
		<!-- cierre form-wrapper -->
		</div>
	</div>

	<div class="user-list mt-8 card bg-white border border-gray-200 p-4 rounded-md">
			<h3 class="subsection-title">
				<span class="title-icon" aria-hidden="true">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-users"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" /><path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /><path d="M21 21v-2a4 4 0 0 0 -3 -3.85" /></svg>
				</span>
				Lista de Usuarios ({{ users.length || 0 }})
			</h3>

			<div *ngIf="users && users.length; else sinUsuarios">
				<div *ngFor="let u of users" class="user-card border-2 rounded-2xl p-4 mb-4 flex items-start justify-between">
					<div class="flex items-center gap-3">
						<div class="avatar" [ngClass]="getAvatarClasses(u)">
							{{ (u.nombreCompleto || u.username || '?').charAt(0) | uppercase }}
						</div>
						<div>
							<div class="font-medium text-lg">{{ u.nombreCompleto || '—' }}</div>
							<div class="text-sm text-gray-600">{{ u.username }} · {{ u.correo }}</div>
							<div class="mt-2 flex items-center gap-2">
								<span class="badge" *ngFor="let r of (u.roles || [])">{{ r }}</span>
								<span class="badge" *ngIf="u.enabled" style="background:#ecfdf5;border-color:#bbf7d0;color:#065f46;">Activo</span>
								<span class="badge" *ngIf="!u.enabled" style="background:#fef2f2;border-color:#fecaca;color:#dc2626;">Inactivo</span>
								<span class="badge" *ngIf="u.sedeNombre">{{ u.sedeNombre }}</span>
							</div>
						</div>
					</div>
					<div class="actions text-sm text-right">
						<button class="text-blue-600 mr-3" (click)="editUser(u)">Editar</button>
						<button class="text-orange-500 mr-3" (click)="deactivateUser(u)">{{ u.enabled ? 'Desactivar' : 'Activar' }}</button>
						<button class="text-red-600" (click)="deleteUser(u)">Eliminar</button>
					</div>
				</div>
			</div>

			<ng-template #sinUsuarios>
				<div class="border-2 border-dashed border-blue-200 rounded-2xl p-6 text-center text-gray-500">
					No hay usuarios registrados todavía.
				</div>
			</ng-template>
		</div>
	