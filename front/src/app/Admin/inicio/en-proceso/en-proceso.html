<div class="heading-row mb-4 flex items-center justify-between">
  <div class="flex items-center gap-3">
    <!-- SVG rojo a la izquierda del t√≠tulo -->
    <div class="icon-left" aria-hidden>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FF395C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-clock-hour-4"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M12 12l3 2" /><path d="M12 7v5" /></svg>
    </div>
  <h2 class="text-xl sm:text-2xl lg:text-3xl m-0">Reportes en Proceso ({{ items.length || 0 }})</h2>
  </div>
  <div class="controls-right flex items-center gap-2">
    <div class="filter-wrapper" style="position:relative;">
      <button class="button button-outline button-sm" (click)="toggleZoneFilter()">Filtrar</button>
      <div *ngIf="showZoneFilter" class="zone-popover card p-2" style="position:absolute; left:0; top:40px; z-index:40; width:220px;">
        <label class="label">Zonas de la sede</label>
        <ul style="list-style:none; padding:0; margin:0; max-height:220px; overflow:auto;">
          <li style="padding:6px 0;"><a (click)="applyZoneFilter(null)" class="link">Todas</a></li>
          <li *ngFor="let z of zonasList" style="padding:6px 0;"><a (click)="applyZoneFilter(z.id)" class="link">{{ z.nombre }}</a></li>
        </ul>
      </div>
    </div>
      <button class="button button-outline button-sm" (click)="refreshEnProceso()">Actualizar Estado</button>
      <button class="button button-outline button-sm inline-flex items-center gap-2" disabled style="pointer-events:none; opacity:1;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-progress" aria-hidden="true"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 20.777a8.942 8.942 0 0 1 -2.48 -.969" /><path d="M14 3.223a9.003 9.003 0 0 1 0 17.554" /><path d="M4.579 17.093a8.961 8.961 0 0 1 -1.227 -2.592" /><path d="M3.124 10.5c.16 -.95 .468 -1.85 .9 -2.675l.169 -.305" /><path d="M6.907 4.579a8.954 8.954 0 0 1 3.093 -1.356" /></svg>
        <span>EN PROGRESO</span>
      </button>
  </div>
</div>

<div *ngIf="items && items.length; else noItems">
  <article *ngFor="let it of items" [ngClass]="cardClassFor(it.priority || '') + ' report-card'">
    <div class="badges">
      <span [ngClass]="priorityBadgeClassFor(it.priority)">{{ (it.priority || '') | uppercase }}</span>
      <span class="badge bg-blue-500">{{ estadoDisplay(it.report) }}</span>
    </div>

    <div class="report-inner">
      <div class="avatar">
        <svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden>
          <circle class="avatar-circle" cx="12" cy="12" r="10" [attr.fill]="avatarFillColorForPriority(it.priority)" />
        </svg>
      </div>

      <div class="report-body">
        <div class="header-row">
          <h3 class="title">{{ it.report?.tipoIncidenteId ? (tiposMap[it.report.tipoIncidenteId] || it.report.descripcion || 'Actividad') : ('Reporte #' + it.id) }}</h3>
        </div>

        <div class="meta-row">
          <svg class="meta-icon" width="14" height="14" viewBox="0 0 24 24"><path d="M21 10c0 6-9 12-9 12S3 16 3 10a9 9 0 1 1 18 0z" fill="#6b7280"/></svg>
          <span>{{ it.report?.zonaId ? (zonasMap[it.report.zonaId] || ('Zona ' + it.report.zonaId)) : 'Sin zona' }}</span>
          <span class="dot">‚Ä¢</span>
          <svg class="meta-icon" width="14" height="14" viewBox="0 0 24 24"><path d="M12 8v5l3 3" stroke="#6b7280" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
          <span>{{ it.report?.fechaCreacion ? (it.report.fechaCreacion | date:'short') : 'Hace poco' }}</span>
          <span class="dot">‚Ä¢</span>
          <span class="id">ID: {{ it.id }}</span>
        </div>

        <p class="description">{{ it.report?.descripcion || 'Detalle del reporte cargado en la lista principal' }}</p>

        <!-- Ver foto debajo de la descripci√≥n si existe -->
        <div *ngIf="getImageSrc(it.report) as img" style="display:flex;align-items:center;gap:8px;margin-top:8px">
          <button class="button button-outline button-sm" (click)="openImageWithFallback(img)">üì∑ Ver foto</button>
          <img [src]="img" class="inline-thumb" alt="Evidencia" (click)="openImageWithFallback(img)" />
        </div>

        <div class="filters-actions-row">
          <div class="filters-panel">
            <div class="form-row">
              <div class="form-col">
                <label class="label">Estado del Proceso</label>
                <div class="info-grid" style="background:#fff; padding:12px; border-radius:8px;">
                  <div style="grid-column:1/-1; margin-bottom:8px;">
                
                    <strong>Estado del proceso: {{ estadoDisplay(it.report) }}</strong>
                  </div>
                  <div>
                    <p>Asignado a</p>
                    <strong>
                      {{ it.assigned ? ('Sec. ' + (it.assigned?.nombreCompleto || (it.assigned?.id ? (usuariosMap[it.assigned.id] || ('S' + it.assigned.id)) : it.assigned?.username) )) : 'Sin asignar' }}
                    </strong>
                  </div>
                  <div>
                    <p>Tiempo en proceso</p>
                    <strong>{{ timeInProcessLabel[it.id] || '‚Äî' }}</strong>
                  </div>
                  <div>
                    <p>√öltima actualizaci√≥n</p>
                    <strong>{{ lastUpdate(it.report) }}</strong>
                  </div>
                </div>
              </div>

              <div class="form-col small">
                <label class="label">Recibido</label>
                <input class="input" type="text" [value]="it.report?.fechaCreacion ? (it.report.fechaCreacion | date:'short') : 'Hace poco'" readonly>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>

  <div class="report-footer">
      <div class="footer-left">
        <svg class="shield-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3l7 3v5c0 5-3.5 9-7 10-3.5-1-7-5-7-10V6l7-3z" fill="#FFFFFF" opacity="0.02" stroke="#6b7280" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="anon-text">{{ it.report?.isAnonimo ? 'Reporte An√≥nimo' : ('Usuario: ' + (usuariosMap[it.report?.usuarioId] || it.report?.usuarioId || '')) }}</span>
      </div>
      <div class="footer-right">
  <button class="btn btn-cancel" (click)="cancelReport(it.id)"> <svg width="14" height="14" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="#ef4444" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg> Cancelar</button>
      </div>
    </div>

  </article>
</div>

<ng-template #noItems>
  <div class="card empty">
    <div class="card-content p-12 text-center">
      <svg class="icon-file-large" width="64" height="64" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z" fill="#e5e7eb"/></svg>
      <h3 class="text-xl mb-2 text-gray-600">No hay reportes en proceso</h3>
      <p class="text-gray-500 mb-6">Todos los reportes est√°n siendo gestionados o han sido resueltos.</p>
      <span class="badge badge-outline px-4 py-2">‚è∏Ô∏è Estado: Sin casos activos</span>
    </div>
  </div>
</ng-template>

<!-- Image preview modal (En Proceso) - overlay fixed; click backdrop to close -->
<div *ngIf="imageModalVisible" class="modal-overlay" (click)="closeImage()" style="position:fixed; left:0; top:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:9999;">
  <div class="modal-card" style="position:relative; z-index:10000; max-width:920px; width:auto; display:inline-block; padding:0;">
    <img [src]="selectedImageSrc" alt="Evidencia" (click)="$event.stopPropagation()" style="max-width:100%; max-height:80vh; border-radius:8px; display:block; margin:0;" />
  </div>
</div>

<div class="card border-2 border-dashed border-gray-300 mt-4">
	<div class="card-content p-12 text-center">
		<i class="clock-icon h-16 w-16 text-gray-400 mx-auto mb-4"></i>
		<h3 class="text-xl mb-2 text-gray-600">No hay reportes en proceso</h3>
		<p class="text-gray-500 mb-6">Todos los reportes est√°n siendo gestionados o han sido resueltos.</p>
		<span class="badge badge-outline px-4 py-2">‚è∏Ô∏è Estado: Sin casos activos</span>
	</div>
</div>
