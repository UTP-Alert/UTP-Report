<h2 class="text-2xl mb-4 flex items-center gap-3">
	<i class="check-circle-icon h-8 w-8 text-green-600"></i>
	Reportes Resueltos ({{ reportes.length }})
</h2>

<div class="resueltos-list">

  <div *ngIf="loading" class="card border-2 border-dashed border-gray-300">
	<div class="card-content p-12 text-center">
		<i class="check-circle-icon h-16 w-16 text-gray-400 mx-auto mb-4"></i>
		<h3 class="text-xl mb-2 text-gray-600">Cargando reportes resueltos...</h3>
	</div>
</div>

<!-- Image preview modal (Resueltos) - overlay fixed; click backdrop to close -->
<div *ngIf="imageModalVisible" class="modal-overlay" (click)="closeImage()" style="position:fixed; left:0; top:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:9999;">
	<div class="modal-card" style="position:relative; z-index:10000; max-width:920px; width:auto; display:inline-block; padding:0;">
		<img [src]="selectedImageSrc" alt="Evidencia" (click)="$event.stopPropagation()" style="max-width:100%; max-height:80vh; border-radius:8px; display:block; margin:0;" />
	</div>
</div>

  <div *ngIf="!loading && reportes.length === 0" class="card border-2 border-dashed border-gray-300">
	<div class="card-content p-12 text-center">
		<i class="check-circle-icon h-16 w-16 text-gray-400 mx-auto mb-4"></i>
		<h3 class="text-xl mb-2 text-gray-600">No hay reportes resueltos</h3>
		<p class="text-gray-500 mb-6">Todos los reportes resueltos se mostrarÃ¡n aquÃ­.</p>
		<span class="badge badge-outline px-4 py-2">ðŸ“‹ Estado: Esperando resoluciones</span>
	</div>
</div>

		<div *ngFor="let r of reportes" class="card resolved-card hover:shadow-lg transition-all mb-4">
			<div class="card-content row-flex">
				<div class="avatar-col">
					<div class="avatar-circle" [style.background]="(r.ultimaPrioridad||'')==='alta' ? '#ef4444' : ((r.ultimaPrioridad||'')==='media' ? '#f59e0b' : '#3b82f6')"></div>
				</div>


			<div class="main-col">
				<div class="title-row">
					<h3 class="title">{{ tiposMap[r.tipoIncidenteId] || 'Reporte' }}</h3>
					<div class="meta small">
						<span class="meta-item">{{ zonasMap[r.zonaId] || (r.zonaId ? ('Zona ' + r.zonaId) : 'Sin zona') }}</span>
						<span class="dot">â€¢</span>
						<span class="meta-item">Resuelto: {{ (r.reporteGestion && r.reporteGestion.fechaActualizacion) ? (r.reporteGestion.fechaActualizacion | date:'short') : (r.fechaUltimaGestion ? (r.fechaUltimaGestion | date:'short') : (r.fechaCreacion | date:'short')) }}</span>
						<span class="dot">â€¢</span>
						<span class="meta-item">ID: {{ r.id }}</span>
					</div>
				</div>

						<p class="desc">{{ r.descripcion }}</p>

						<!-- Ver foto debajo de la descripciÃ³n -->
								<div *ngIf="getImageSrc(r) as img" style="display:flex;align-items:center;gap:8px;margin-top:8px">
									<button class="button-outline button-sm" (click)="openImage(img)">ðŸ“· Ver foto</button>
									<img [src]="img" class="inline-thumb" alt="Evidencia" (click)="openImage(img)" />
								</div>

						<div class="icons-row">
					<span class="icon-item">ðŸ“· Evidencia: {{ r.foto ? 'sÃ­' : 'no' }}</span>
					<span class="icon-item">ðŸ”” {{ r.contacto ? 'Con contacto' : 'Sin contacto' }}</span>
					<span class="icon-item">âœ… Caso cerrado exitosamente</span>
				</div>
			</div>

			<div class="actions-col">
				<div class="badges-top">
					<span class="badge priority" [ngClass]="{'high': (r.ultimaPrioridad||'')==='alta','medium': (r.ultimaPrioridad||'')==='media','low': (r.ultimaPrioridad||'')==='baja'}">{{ (r.ultimaPrioridad||'') | uppercase }}</span>
					<span class="badge resuelto">RESUELTO</span>
				</div>

				<div class="actions">
					<button class="button button-sm button-outline" (click)="abrirDetalle(r)"><i class="eye-icon h-4 w-4 mr-1"></i>Ver Detalle</button>
				</div>
			</div>

		</div>
	</div>

</div>

<!-- Modal Detalle Completo Reporte Resuelto -->
<div *ngIf="detalleVisible && reporteSeleccionado as det" class="modal-overlay" (click)="cerrarDetalle()" style="position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; display:flex; align-items:flex-start; justify-content:center; padding:40px 24px; overflow:auto;">
	<div class="modal-card" (click)="$event.stopPropagation()" style="background:#ffffff; width:1400px; max-width:100%; border-radius:20px; box-shadow:0 30px 60px -12px rgba(0,0,0,0.35); border:1px solid #e5e7eb; display:flex; flex-direction:column;">
		<!-- Header -->
		<div style="display:flex; align-items:center; justify-content:space-between; padding:18px 28px; border-bottom:1px solid #f1f5f9;">
			<div style="display:flex; align-items:center; gap:18px;">
				<div style="width:14px; height:42px; border-radius:8px;" [style.background]="(det.ultimaPrioridad||'')==='alta' ? '#ef4444' : ((det.ultimaPrioridad||'')==='media' ? '#f59e0b' : '#3b82f6')"></div>
				<div>
					<div style="font-size:20px; font-weight:700;">{{ tiposMap[det.tipoIncidenteId] || 'Reporte' }}</div>
					<div style="color:#64748b; font-size:13px;">{{ zonasMap[det.zonaId] || ('Zona '+det.zonaId) }} â€¢ ID: {{ det.id }}</div>
				</div>
			</div>
			<button (click)="cerrarDetalle()" style="background:#f1f5f9; border:none; width:40px; height:40px; border-radius:12px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px;">âœ•</button>
		</div>
		<!-- Body -->
		<div style="padding:24px 28px 32px 28px; display:flex; flex-direction:column; gap:28px;">
			<!-- SecciÃ³n superior: Datos iniciales y evidencia -->
			<div style="display:grid; grid-template-columns: 480px 1fr; gap:32px; align-items:start;">
				<!-- Columna reporte original -->
				<div style="display:flex; flex-direction:column; gap:16px;">
					<div style="display:flex; align-items:center; gap:14px;">
						<div style="width:56px; height:56px; border-radius:50%; background:#e2e8f0; display:flex; align-items:center; justify-content:center; font-weight:600; color:#475569; font-size:13px;">
							{{ det.isAnonimo ? 'A' : (det.usuarioId || 'U') }}
						</div>
						<div>
							<div style="font-weight:600; font-size:15px;">{{ det.isAnonimo ? 'AnÃ³nimo' : 'Usuario #'+det.usuarioId }}</div>
							<div style="color:#64748b; font-size:12px;">{{ det.isAnonimo ? 'Reporte AnÃ³nimo' : 'Con contacto' }}</div>
						</div>
						<div style="margin-left:auto; display:flex; gap:8px;">
							<span style="padding:4px 10px; border-radius:16px; font-size:11px; font-weight:600; color:#fff;" [style.background]="(det.ultimaPrioridad||'')==='alta' ? '#dc2626' : ((det.ultimaPrioridad||'')==='media' ? '#d97706' : '#2563eb')">{{ (det.ultimaPrioridad||'') | uppercase }}</span>
							<span style="padding:4px 10px; border-radius:16px; font-size:11px; font-weight:600; background:#10b981; color:#fff;">RESUELTO</span>
						</div>
					</div>
					<div style="border:1px solid #e2e8f0; background:#f8fafc; border-radius:16px; padding:16px;">
						<div style="font-weight:600; font-size:14px; margin-bottom:6px;">DescripciÃ³n inicial</div>
						<div style="font-size:13px; line-height:1.45; color:#334155; white-space:pre-wrap;">{{ det.descripcion }}</div>
					</div>
					<div *ngIf="getImageSrc(det) as img" style="display:flex; flex-direction:column; gap:10px;">
						<div style="font-weight:600; font-size:14px;">Evidencia</div>
						<div style="display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap;">
							<img [src]="img" (click)="openImage(img)" alt="Evidencia" style="width:180px; height:180px; object-fit:cover; border-radius:14px; border:1px solid #e2e8f0; cursor:pointer;" />
							<div style="display:flex; flex-direction:column; gap:10px;">
								<button (click)="openImage(img)" style="background:#fff; border:1px solid #cbd5e1; padding:8px 14px; border-radius:10px; font-size:12px; cursor:pointer;">Abrir evidencia</button>
								<div style="font-size:12px; color:#64748b;">Click para ampliar en un visor modal.</div>
							</div>
						</div>
					</div>
					<div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:16px;">
									<div style="background:#f1f5f9; border:1px solid #e2e8f0; padding:12px; border-radius:14px;">
										<div style="color:#64748b; font-size:11px; text-transform:uppercase; font-weight:600;">Pendiente</div>
							<div style="font-size:12px; margin-top:4px;">{{ det.fechaCreacion | date:'dd/MM/yy, h:mm a' }}</div>
						</div>
						<div style="background:#f1f5f9; border:1px solid #e2e8f0; padding:12px; border-radius:14px;">
							<div style="color:#64748b; font-size:11px; text-transform:uppercase; font-weight:600;">Ãšltima gestiÃ³n</div>
							<div style="font-size:12px; margin-top:4px;">{{ (det.reporteGestion?.fechaActualizacion || det.fechaUltimaGestion || det.fechaCreacion) | date:'dd/MM/yy, h:mm a' }}</div>
						</div>
					</div>
				</div>
				<!-- Columna estados en grid -->
				<div style="display:flex; flex-direction:column; gap:22px;">
					<div style="font-weight:700; font-size:15px;">Estados y tiempos</div>
											<div class="states-columns" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:18px; max-width:100%; overflow-x:auto;">
												<div *ngFor="let e of estadosDetalleList; trackBy: trackEstado; let i=index" style="background:#ffffff; border:1px solid #e2e8f0; border-radius:18px; padding:14px 16px; display:flex; flex-direction:column; gap:12px; position:relative;">
							<div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
								<div style="display:flex; align-items:center; gap:8px;">
												<span [style.background]="
													e.key==='PENDIENTE' ? '#3b82f6' :
													e.key==='UBICANDO' ? '#22c55e' :
													e.key==='INVESTIGANDO' ? '#f59e0b' :
													e.key==='PENDIENTE_APROBACION' ? '#6366f1' :
													e.key==='RESUELTO' ? '#10b981' : '#ef4444'" 
													style="width:11px; height:11px; border-radius:50%;"></span>
									<div style="font-size:13px; font-weight:600;">{{ e.label }}</div>
								</div>
								<div style="color:#64748b; font-size:11px; font-weight:500;">{{ e.fecha ? (e.fecha | date:'dd/MM/yy, h:mm a') : 'No registrado' }}</div>
							</div>
							<div *ngIf="e.fecha" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
								<div style="display:flex; flex-direction:column; gap:2px;">
									<div style="color:#94a3b8; font-size:10px; font-weight:600; text-transform:uppercase;">Fecha</div>
									<div style="font-size:12px; font-weight:500;">{{ e.fecha | date:'dd/MM/yy' }}</div>
								</div>
								<div style="display:flex; flex-direction:column; gap:2px;">
									<div style="color:#94a3b8; font-size:10px; font-weight:600; text-transform:uppercase;">Hora</div>
									<div style="font-size:12px; font-weight:500;">{{ e.fecha | date:'h:mm a' }}</div>
								</div>
							</div>
							<!-- Comentarios -->
							<ng-container *ngIf="e.comentarios as cm; else noComment"> 
								<div [ngStyle]="{ background: e.origin==='admin' ? '#fff7ed' : '#eff6ff', border: e.origin==='admin' ? '1px solid #fde68a' : '1px solid #bfdbfe' }" style="padding:10px 12px; border-radius:14px;">
									<div [ngStyle]="{color: e.origin==='admin' ? '#92400e' : '#1d4ed8', 'font-size':'12px', 'font-weight':'600'}">{{ e.origin==='admin' ? 'Administrador' : 'Seguridad' }}</div>
									<div [ngStyle]="{color: e.origin==='admin' ? '#78350f' : '#1e3a8a'}" style="font-size:12px; line-height:1.4; white-space:pre-wrap;">{{ cm }}</div>
								</div>
							</ng-container>
							<ng-template #noComment>
								<div style="color:#94a3b8; font-size:11px;">Sin comentarios.</div>
							</ng-template>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
